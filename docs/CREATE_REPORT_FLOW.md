# Create Report 処理フロー

## 概要

「Create Report」ボタンを押した際の処理フローを説明します。

## 処理フロー

```
┌─────────────────────────────────────────────────────────┐
│ 1. 週の開始日を計算                                      │
│    weekStart = getWeekStartDate()                       │
│    filePath = getReportFilePath(weekStart)              │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│ 2. ファイル存在チェック                                  │
│    file = vault.getAbstractFileByPath(filePath)         │
└─────────────────────────────────────────────────────────┘
                           ↓
          ┌────────────────┴────────────────┐
          ↓                                 ↓
┌─────────────────────┐          ┌─────────────────────┐
│ ファイルなし         │          │ ファイルあり         │
│                     │          │                     │
│ → 空テンプレートで   │          │ → 作成スキップ       │
│   ファイル作成       │          │   「既に存在」通知    │
│   isNew = true      │          │   isNew = false     │
└─────────────────────┘          └─────────────────────┘
          │                                 │
          └────────────────┬────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│ 3. ファイルを開く                                        │
│    workspace.openFile(file)                             │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│ 4. スケジュール同期 (isNew = true の場合のみ)            │
│                                                         │
│    4-1. カレンダーからスケジュール取得                   │
│         schedule = fetchWeeklySchedule(weekStart)       │
│                                                         │
│    4-2. 7日分ループ                                      │
│         for (i = 0..6) {                                │
│           date = weekStart + i日                        │
│           updateScheduleInReport(date, schedule)        │
│         }                                               │
│                                                         │
│    4-3. サイドバービューをリフレッシュ                   │
└─────────────────────────────────────────────────────────┘
```

## 設計のポイント

### 即時性
- ファイル作成→オープンまでが先に完了するため、ユーザーはすぐにファイルを見ることができます
- カレンダー取得の待ち時間でユーザーを待たせません

### 既存ファイル保護
- すでにファイルがある場合は上書きせず、単に開くだけです
- ユーザーが編集した内容が失われることはありません

### 非同期スケジュール更新
- 新規作成時のみ、ファイルを開いた後にスケジュール取得＆書き込みが走ります
- カレンダー取得に失敗しても、ファイル自体は正常に作成・表示されています

## 通知メッセージ

| 状況 | 通知/UI |
|------|------|
| 新規作成完了 | 「週報を作成しました: {filePath}」 |
| ファイル既存 | 「{filePath} already exists」 |
| スケジュール同期中 | リロードボタンが回転（通知なし） |
| スケジュール取得失敗 | 「スケジュールの取得に失敗しました」 |

## 関連メソッド

- `WeeknotePlugin.createWeeknote()`: メイン処理
- `WeeknoteGenerator.getWeekStartDate()`: 週開始日の計算
- `WeeknoteGenerator.getReportFilePath()`: ファイルパス生成
- `WeeknoteGenerator.createReport()`: ファイル作成
- `CalendarService.fetchWeeklySchedule()`: カレンダー取得
- `WeeknotePlugin.updateScheduleInReport()`: スケジュール書き込み
